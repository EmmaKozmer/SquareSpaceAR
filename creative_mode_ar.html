<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Creative Mode - My Square Space</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://unpkg.com/three@0.126.1/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.126.1/examples/js/loaders/GLTFLoader.js"></script>
    
    <style>
        .model-option {
            cursor: pointer;
            display: inline-block;
            margin: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="creative-mode-container">
        <a href="creative_mode.html" class="back-button-creative-mode">&#8592;</a>
        <h1>Place Your 3D Models</h1>
        <p class="intro-text">
            Place your desired 3D models into the picture. You can choose from the available 3D models below.
        </p>

        <!-- Display the chosen or captured image -->
        <div style="text-align: center;">
            <div id="imageContainer" style="position: relative; display: inline-block;">
                <img id="displayedImage" src="" alt="Uploaded Image" style="max-width: 100%; height: auto;">
                <div id="modelOverlay" style="position: absolute; top: 0; left: 0; pointer-events: none;"></div>
            </div>
        </div>

        <!-- Container for 3D model options -->
        <div id="modelOptions">
            <a rel="ar" href="../objects/buddha_new.usdz">
                <img src="../thumbnails/buddha.png" alt="Buddha Model" class="model-option" draggable="true" ondragstart="drag(event)" id="buddha">
            </a>
            <a rel="ar" href="../objects/small_table_new.usdz">
                <img src="../thumbnails/table.png" alt="Table Model" class="model-option" draggable="true" ondragstart="drag(event)" id="table">
            </a>
            <a rel="ar" href="../objects/armchair_new.usdz">
                <img src="../thumbnails/armchair.png" alt="Armchair Model" class="model-option" draggable="true" ondragstart="drag(event)" id="armchair">
            </a>
        </div>

        <!-- Div for Three.js content -->
        <div id="scene-container" style="width: 100%; height: 400px;"></div>
    </div>

    <!-- Scripts should be loaded after the content -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.126.1/examples/js/loaders/GLTFLoader.js"></script>
    <script>
        window.onload = function() {
            var imgSrc = localStorage.getItem('chosenImage');
            if (imgSrc) {
                document.getElementById('displayedImage').src = imgSrc;
            }
        };

        function drag(event) {
            event.dataTransfer.setData("text/plain", event.target.id);
            console.log('Dragging ' + event.target.id);
        }

        // Attach event listeners to the AR scene to allow dropping
        var arScene = document.getElementById('imageContainer');
        arScene.ondragover = function(event) {
            event.preventDefault(); // Necessary to allow dropping
            console.log('Drag over');
        };

        arScene.ondrop = function(event) {
            console.log('Dropped');
            event.preventDefault();
            var data = event.dataTransfer.getData("text/plain");
            var model = document.getElementById(data); // Clone the thumbnail
            model.style.position = 'absolute';
            model.style.left = event.offsetX + 'px';
            model.style.top = event.offsetY + 'px';
            model.style.transform = 'translate(-50%, -50%)'; // Center the model on the coordinates
            arScene.appendChild(model); // Add the model to the AR scene
        };
    </script>
    
    <script type="module">
    import * as THREE from 'https://unpkg.com/three/build/three.module.js';
    import { GLTFLoader } from 'https://threejs.org/examples/jsm/loaders/GLTFLoader.js';

    let scene, camera, renderer, loader;

    document.addEventListener('DOMContentLoaded', () => {
        init();
        var imgSrc = localStorage.getItem('chosenImage');
        if (imgSrc) {
            document.getElementById('displayedImage').src = imgSrc;
        }
    });

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('scene-container').appendChild(renderer.domElement);

        loader = new GLTFLoader();

        const light = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
        scene.add(light);

        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    function drag(event) {
        event.dataTransfer.setData("text", event.target.dataset.model);
    }

    document.getElementById('imageContainer').addEventListener('dragover', (event) => {
        event.preventDefault();
    });

    document.getElementById('imageContainer').addEventListener('drop', (event) => {
        event.preventDefault();
        const modelPath = event.dataTransfer.getData("text");
        loader.load(modelPath, function(gltf) {
            scene.add(gltf.scene);
        });
    });
</script>

</body>
</html>